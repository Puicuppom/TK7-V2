<script>
    // --- CONFIGURATION ---
    const API_KEY = 'AIzaSyCEBJ4r6fNvUmG0yMS39HL2fHitTEUHxSc'; 
    const CLIENT_ID = '957671796761-qf1dq8hn2sla96usu0gd0tn5r0uff0b6.apps.googleusercontent.com';
    const SPREADSHEET_ID = '10kWqj4SufMEujISUZptlYwaVjF6k6K5p1FUQzBHQFgk';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email';

    // --- GLOBAL STATE for API loading ---
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let isDomReady = false;
    let appStarted = false;

    // --- App State and Elements (declared globally, assigned later) ---
    let adminEmails = [];
    let appData = {}, activePage = 'page-schedule', currentDateKey = new Date().toISOString().split('T')[0], currentEditingContext = { index: null, side: null }, currentUser = false, isInitialSetupDone = false, draggedItem = null;
    let lastScrollPosition = 0, shouldRestoreScroll = false;
    let debouncedUpdateInSheet;
    let contentContainer, pages, navButtons, loginBtn, logoutBtn, userInfo, teamSelectModal;
    const SVG_TRASH = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/></svg>`;
    const TEAMS = [ { name: '‡∏ó‡∏µ‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', slug: 'green' }, { name: '‡∏ó‡∏µ‡∏°‡πÅ‡∏î‡∏á', slug: 'red' }, { name: '‡∏ó‡∏µ‡∏°‡∏Ç‡∏≤‡∏ß', slug: 'white' }, { name: '‡∏ó‡∏µ‡∏°‡∏ü‡πâ‡∏≤', slug: 'blue' }, { name: '‡∏ó‡∏µ‡∏°‡∏î‡∏≥', slug: 'black' }, { name: '‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', slug: 'yellow' }, { name: '‡∏ó‡∏µ‡∏°‡∏ä‡∏°‡∏û‡∏π', slug: 'pink' }, { name: '‡∏ó‡∏µ‡∏°‡∏™‡πâ‡∏°', slug: 'orange' }, { name: '‡∏ó‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', slug: 'navy' }, { name: '‡∏ó‡∏µ‡∏°‡∏°‡πà‡∏ß‡∏á', slug: 'purple' } ];
    const MASTER_TEMPLATES = { '6-teams': [{ name: '6 ‡∏ó‡∏µ‡∏°', data: [ {home:1,away:6},{home:2,away:5},{home:3,away:4},{home:1,away:5},{home:6,away:4}, {home:2,away:3},{home:1,away:4},{home:5,away:3},{home:6,away:2},{home:1,away:3}, {home:4,away:2},{home:5,away:6},{home:1,away:2},{home:3,away:6},{home:4,away:5}, {home:6,away:1},{home:5,away:2},{home:4,away:3},{home:5,away:1},{home:4,away:6}, {home:3,away:2},{home:4,away:1},{home:3,away:5},{home:2,away:6},{home:3,away:1}, {home:2,away:4},{home:6,away:5},{home:2,away:1},{home:6,away:3},{home:5,away:4} ]}], '5-teams': [ { name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á 1', data: [ {home:1, away:2}, {home:3, away:4}, {home:5, away:1}, {home:2, away:3}, {home:4, away:5}, {home:1, away:3}, {home:2, away:4}, {home:3, away:5}, {home:1, away:4}, {home:2, away:5}, {home:3, away:4}, {home:1, away:2}, {home:5, away:3}, {home:4, away:1}, {home:2, away:5}, {home:3, away:1}, {home:4, away:2}, {home:1, away:5}, {home:3, away:2}, {home:4, away:5} ] }, { name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á 2', data: [ {home:5, away:1}, {home:2, away:3}, {home:4, away:5}, {home:1, away:2}, {home:3, away:4}, {home:5, away:2}, {home:1, away:3}, {home:2, away:4}, {home:5, away:3}, {home:1, away:4}, {home:2, away:3}, {home:5, away:1}, {home:4, away:2}, {home:3, away:5}, {home:1, away:4}, {home:2, away:5}, {home:3, away:1}, {home:5, away:4}, {home:2, away:1}, {home:3, away:4} ] }, { name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á 3', data: [ {home:4, away:5}, {home:1, away:2}, {home:3, away:4}, {home:5, away:1}, {home:2, away:3}, {home:4, away:1}, {home:5, away:2}, {home:1, away:3}, {home:4, away:2}, {home:5, away:3}, {home:1, away:2}, {home:4, away:5}, {home:3, away:1}, {home:2, away:4}, {home:5, away:3}, {home:1, away:4}, {home:2, away:5}, {home:4, away:3}, {home:1, away:5}, {home:2, away:3} ] }, { name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á 4', data: [ {home:3, away:4}, {home:5, away:1}, {home:2, away:3}, {home:4, away:5}, {home:1, away:2}, {home:3, away:5}, {home:4, away:1}, {home:5, away:2}, {home:3, away:1}, {home:4, away:2}, {home:5, away:1}, {home:3, away:4}, {home:2, away:5}, {home:1, away:3}, {home:4, away:2}, {home:5, away:3}, {home:1, away:4}, {home:3, away:2}, {home:5, away:4}, {home:1, away:2} ] }, { name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á 5', data: [ {home:2, away:3}, {home:4, away:5}, {home:1, away:2}, {home:3, away:4}, {home:5, away:1}, {home:2, away:4}, {home:3, away:5}, {home:4, away:1}, {home:2, away:5}, {home:3, away:1}, {home:4, away:5}, {home:2, away:3}, {home:1, away:4}, {home:5, away:2}, {home:3, away:1}, {home:4, away:2}, {home:5, away:3}, {home:2, away:1}, {home:4, away:3}, {home:5, away:1} ] } ], '4-teams': [{ name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á 1', data: [ {home:1, away:2}, {home:3, away:4}, {home:4, away:1}, {home:2, away:3}, {home:3, away:1}, {home:4, away:2}, {home:1, away:3}, {home:2, away:4}, {home:3, away:2}, {home:1, away:4}, {home:2, away:1}, {home:4, away:3} ]}] };
        
        // --- GLOBAL CALLBACKS for Google Scripts ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', });
                gisInited = true;
                checkAllLoadedAndStart();
            } catch (err) {
                console.error("Error initializing Google Sign-In:", err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á Google ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Client ID ‡πÅ‡∏•‡∏∞ Origin URL");
            }
        }
        async function initializeGapiClient() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'], });
                gapiInited = true;
                checkAllLoadedAndStart();
            } catch (err) {
                console.error("Error initializing GAPI client:", err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google API ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key");
            }
        }

        // --- APP LIFECYCLE ---
        document.addEventListener('DOMContentLoaded', () => {
            isDomReady = true;
            checkAllLoadedAndStart();
        });
        function checkAllLoadedAndStart() {
            if (gapiInited && gisInited && isDomReady && !appStarted) {
                appStarted = true;
                startApp();
            }
        }
        async function startApp() {
            assignDOMElements();
            initEventListeners();
            await loadAdminEmails();
            await updateSigninStatus();
            await loadInitialData();
            setupPolling();
        }
        function assignDOMElements() {
            contentContainer = document.getElementById('content');
            pages = document.querySelectorAll('.page');
            navButtons = document.querySelectorAll('.nav-btn');
            loginBtn = document.getElementById('login-btn');
            logoutBtn = document.getElementById('logout-btn');
            userInfo = document.getElementById('user-info');
            teamSelectModal = document.getElementById('team-select-modal');
            debouncedUpdateInSheet = debounce(updateScheduleOrderInSheet, 1500);
        }
        function initEventListeners() {
            loginBtn.addEventListener('click', handleAuthClick);
            logoutBtn.addEventListener('click', handleSignoutClick);
            document.getElementById('export-schedule-btn').addEventListener('click', (e) => exportElementAsPNG('schedule-container', `TK7-Schedule-${currentDateKey}.png`, e.currentTarget));
            document.getElementById('export-scores-btn').addEventListener('click', (e) => exportElementAsPNG('scores-container', `TK7-Scores-${currentDateKey}.png`, e.currentTarget));
            document.getElementById('export-leaderboard-btn').addEventListener('click', (e) => exportElementAsPNG('leaderboard-container', `TK7-Leaderboard-${currentDateKey}.png`, e.currentTarget));
            setupNavigation();
            document.querySelector('#team-select-modal .close-modal-btn').addEventListener('click', () => teamSelectModal.style.display = 'none');
            window.addEventListener('click', (event) => { if (event.target == teamSelectModal) { event.target.style.display = "none"; } });
            setupDragAndDropListeners(document.getElementById('schedule-container'));
            document.getElementById('generate-schedule-btn').addEventListener('click', generateAndSaveScheduleToSheet);
            document.getElementById('delete-day-btn').onclick = () => {
                const dateToDelete = document.getElementById('schedule-date-selector').value;
                if(dateToDelete && dateToDelete !== '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
                    deleteDayFromSheet(dateToDelete);
                }
            };
            contentContainer.addEventListener('click', handleMainClick);
        }

        // --- AUTHENTICATION ---
        function handleAuthClick() {
            if (!tokenClient) return;
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) { console.error("Login Error:", resp); return; }
                await updateSigninStatus();
            };
            // <<< ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏≠‡∏≤ prompt: 'consent' ‡∏≠‡∏≠‡∏Å
            tokenClient.requestAccessToken({ prompt: '' });
        }
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, async () => {
                    gapi.client.setToken('');
                    await updateSigninStatus();
                });
            }
        }
        async function updateSigninStatus() {
            const token = gapi.client.getToken();
            const isLoggedIn = token !== null;
            let isAdmin = false;
            if (isLoggedIn) {
                try {
                    const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${token.access_token}` } });
                    if (!response.ok) throw new Error(`Failed to fetch user info: ${response.statusText}`);
                    const profile = await response.json();
                    const userEmail = profile.email.toLowerCase();
                    if (adminEmails.includes(userEmail)) {
                        isAdmin = true;
                        userInfo.textContent = `üë§ ${userEmail}`;
                        userInfo.style.display = 'inline-block';
                    }
                } catch (err) { console.error("Error fetching user profile", err); isAdmin = false; }
            }
            if (!isAdmin) { userInfo.style.display = 'none'; }
            currentUser = isAdmin;
            loginBtn.style.display = isAdmin ? 'none' : 'inline-block';
            logoutBtn.style.display = isAdmin ? 'inline-block' : 'none';
            document.querySelector('.nav-btn[data-page="page-setup"]').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('delete-day-btn').style.display = isAdmin ? 'inline-flex' : 'none';
            if (!isAdmin && activePage === 'page-setup') { setActivePage('page-schedule'); }
            renderAllPagesForDate(currentDateKey);
        }
        async function loadAdminEmails() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Admins!A2:A' });
                const values = response.result.values;
                adminEmails = (values && values.length > 0) ? values.flat().map(email => email.trim().toLowerCase()) : [];
            } catch (err) { handleApiError(err, "Error loading admin emails"); adminEmails = []; }
        }

        // --- DATA HANDLING & POLLING ---
        function setupPolling() { setInterval(async () => { if (!document.hidden && activePage !== 'page-setup' && gapiInited) { saveScrollPosition(); shouldRestoreScroll = true; await loadDataForDate(currentDateKey, true); } }, 30000); }
        async function loadInitialData() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'MatchDays!A2:A' });
                let availableDates = [];
                if (response.result.values && response.result.values.length > 0) { availableDates = response.result.values.flat().filter(d => d).sort((a, b) => new Date(b) - new Date(a)); }
                updateDateSelectorsUI(availableDates);
                const initialDate = document.getElementById('schedule-date-selector').value || (availableDates.length > 0 ? availableDates[0] : new Date().toISOString().split('T')[0]);
                await loadDataForDate(initialDate);
            } catch (err) { handleApiError(err, "Error loading initial data"); }
        }
        async function loadDataForDate(date, isPolling = false) {
            if (!date) return;
            if (!isPolling) { currentDateKey = date; updateAllDatePickers(date); }
            try {
                const settingsResponse = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'MatchDays!A:F' });
                const allSettingsRows = settingsResponse.result.values || [];
                const settingsHeader = allSettingsRows.shift() || [];
                const settingsRow = allSettingsRows.find(row => row[0] === date);
                if (!settingsRow) { appData[date] = null; if(currentUser) resetSettingsForm(); renderAllPagesForDate(date); return; }
                const settings = {
                    timePerMatch: parseInt(settingsRow[settingsHeader.indexOf('time_per_match')]) || 9,
                    startTime: settingsRow[settingsHeader.indexOf('start_time')] || '20:00',
                    activeTeams: settingsRow[settingsHeader.indexOf('active_teams')] ? settingsRow[settingsHeader.indexOf('active_teams')].split(',') : [],
                    opener: { home: settingsRow[settingsHeader.indexOf('opener_home')] || '', away: settingsRow[settingsHeader.indexOf('opener_away')] || '' }
                };
                const scheduleResponse = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A:F' });
                const allScheduleRows = scheduleResponse.result.values || [];
                const scheduleHeader = allScheduleRows.shift() || [];
                const scheduleRowsForDate = allScheduleRows.filter(row => row[0] === date);
                const schedule = scheduleRowsForDate.map(row => ({
                    match_index: parseInt(row[scheduleHeader.indexOf('match_index')]),
                    home: row[scheduleHeader.indexOf('home_team')], away: row[scheduleHeader.indexOf('away_team')],
                    homeScore: row[scheduleHeader.indexOf('home_score')] === '' || row[scheduleHeader.indexOf('home_score')] === undefined ? null : parseInt(row[scheduleHeader.indexOf('home_score')]),
                    awayScore: row[scheduleHeader.indexOf('away_score')] === '' || row[scheduleHeader.indexOf('away_score')] === undefined ? null : parseInt(row[scheduleHeader.indexOf('away_score')]),
                })).sort((a, b) => a.match_index - b.match_index).map(({match_index, ...rest}) => rest);
                appData[date] = { match_date: date, settings: settings, schedule: schedule };
                if (currentUser && !isPolling) loadSettingsFromData(settings);
                renderAllPagesForDate(date);
                restoreScrollPosition();
            } catch (err) { handleApiError(err, `Error loading data for date ${date}`); }
        }
        async function updateScheduleOrderInSheet(newOrderedSchedule) {
            if (!currentUser) return;
            const date = currentDateKey;
            try {
                const scheduleData = newOrderedSchedule.map((match, index) => [date, index, match.home, match.away, match.homeScore === null ? '' : match.homeScore, match.awayScore === null ? '' : match.awayScore]);
                const allSchedules = (await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A:F' })).result.values || [];
                const otherSchedules = allSchedules.slice(1).filter(row => row[0] !== date);
                const finalData = [...otherSchedules, ...scheduleData];
                await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A2:F' });
                if (finalData.length > 0) { await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A2', valueInputOption: 'USER_ENTERED', resource: { values: finalData } }); }
                appData[date].schedule = newOrderedSchedule;
                renderSchedulePage(date);
                showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            } catch (err) { handleApiError(err, 'Error updating schedule order'); }
        }
        async function updateScoreInSheet(index, team, value) {
            if (!currentUser) { showToast("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Å‡πà‡∏≠‡∏ô"); return; }
            try {
                const date = currentDateKey;
                const findResponse = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `Schedules!A:B` });
                const rows = findResponse.result.values || [];
                const rowIndex = rows.findIndex(row => row[0] === date && parseInt(row[1]) === index) + 1;
                if (rowIndex < 1) { console.error(`Match not found for date: ${date}, index: ${index}`); showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï"); return; }
                const targetColumn = (team === 'home') ? 'E' : 'F';
                const updateRange = `Schedules!${targetColumn}${rowIndex}`;
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: updateRange, valueInputOption: 'USER_ENTERED', resource: { values: [[value === null ? '' : value]] } });
                appData[date].schedule[index][`${team}Score`] = value;
                renderLeaderboardPage(date);
            } catch (err) { handleApiError(err, 'Error updating score'); await loadDataForDate(currentDateKey); }
        }
        async function generateAndSaveScheduleToSheet() {
            if (!currentUser) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            const date = document.getElementById('match-date').value;
            if (!date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
            const settings = {
                timePerMatch: parseInt(document.getElementById('time-per-match').value),
                startTime: document.getElementById('start-time').value,
                activeTeams: Array.from(document.querySelectorAll('.team-switch:checked')).map(sw => sw.dataset.teamSlug),
                opener: { home: document.getElementById('opener-home').value, away: document.getElementById('opener-away').value }
            };
            if (settings.activeTeams.length < 2) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ó‡∏µ‡∏°');
            if (settings.opener.home && settings.opener.away && settings.opener.home === settings.opener.away) return alert('‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤-‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô');
            let schedule;
            const teamCount = settings.activeTeams.length;
            const templateKey = `${teamCount}-teams`;
            const templateIndex = parseInt(document.getElementById('template-selector').value) || 0;
            if (MASTER_TEMPLATES[templateKey]) { schedule = generateScheduleFromTemplate(settings.activeTeams, templateIndex, (teamCount === 6) ? settings.opener : null); } 
            else { schedule = generateDoubleRoundRobin(settings.activeTeams); if (settings.opener && settings.opener.home && settings.opener.away) { const openerIndex = schedule.findIndex(m => m.home === settings.opener.home && m.away === settings.opener.away); if (openerIndex > 0) { schedule = [...schedule.slice(openerIndex), ...schedule.slice(0, openerIndex)]; } } }
            const finalSchedule = schedule.map(match => ({...match, homeScore: null, awayScore: null}));
            try {
                const findResponse = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `MatchDays!A:A` });
                const dateRows = (findResponse.result.values || []).slice(1);
                const rowIndex = dateRows.findIndex(row => row[0] === date);
                if (rowIndex > -1) { if (!confirm("‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return; await deleteDayFromSheet(date, true); }
                const matchDayData = [date, settings.timePerMatch, settings.startTime, settings.activeTeams.join(','), settings.opener.home, settings.opener.away];
                const scheduleData = finalSchedule.map((match, index) => [date, index, match.home, match.away, '', '']);
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'MatchDays!A1', valueInputOption: 'USER_ENTERED', resource: { values: [matchDayData] } });
                if(scheduleData.length > 0) { await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A1', valueInputOption: 'USER_ENTERED', resource: { values: scheduleData } }); }
                showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                await loadInitialData();
                currentDateKey = date;
                await loadDataForDate(date);
                setActivePage('page-schedule');
            } catch(err) { handleApiError(err, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); }
        }
        async function deleteDayFromSheet(dateToDelete, silent = false) {
            if (!currentUser) return;
            if (!silent && !confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateToDelete} ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) return;
            try {
                const allMatchDays = (await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'MatchDays!A:F' })).result.values || [];
                const allSchedules = (await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A:F' })).result.values || [];
                const newMatchDays = allMatchDays.filter((row, index) => index === 0 || row[0] !== dateToDelete);
                const newSchedules = allSchedules.filter((row, index) => index === 0 || row[0] !== dateToDelete);
                await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: 'MatchDays!A:Z' });
                await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A:Z' });
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'MatchDays!A1', valueInputOption: 'USER_ENTERED', resource: { values: newMatchDays } });
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: 'Schedules!A1', valueInputOption: 'USER_ENTERED', resource: { values: newSchedules } });
                if (!silent) showToast(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateToDelete} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                delete appData[dateToDelete];
                await loadInitialData();
            } catch (err) { handleApiError(err, "Error deleting day data"); }
        }
        
        // --- UTILITY & RENDER FUNCTIONS (ALL FUNCTIONS BELOW THIS LINE ARE UNCHANGED) ---
        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
        function saveScrollPosition() { lastScrollPosition = contentContainer.scrollTop; }
        function restoreScrollPosition() { if (shouldRestoreScroll) { requestAnimationFrame(() => { contentContainer.scrollTop = lastScrollPosition; }); } shouldRestoreScroll = false; }
        function renderWithMorph(container, newHtml) { morphdom(container, `<div>${newHtml}</div>`, { childrenOnly: true }); }
        function handleApiError(error, message) { console.error(message, error); const errorMessage = error.result?.error?.message || error.message || '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤'; alert(`${message}: ${errorMessage}`); }
        function showToast(message) { const toast = document.createElement('div'); toast.className = 'toast-notification'; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => { document.body.removeChild(toast); }, 2500); }, 2500); }
        function createNoDataMessage(message, icon) { return `<div id="no-data-message"><div class="icon">${icon}</div><p>${message}</p></div>`; }
        function updateAllDatePickers(date) { const selectors = [ document.getElementById('schedule-date-selector'), document.getElementById('scores-date-selector'), document.getElementById('leaderboard-date-selector') ]; selectors.forEach(s => s.value = date); if(document.getElementById('match-date')) { document.getElementById('match-date').value = date; }}
        function updateDateSelectorsUI(dates) {
            const selectors = [ document.getElementById('schedule-date-selector'), document.getElementById('scores-date-selector'), document.getElementById('leaderboard-date-selector') ];
            selectors.forEach(selector => {
                const currentVal = selector.value;
                selector.innerHTML = '';
                if (dates.length === 0) { selector.innerHTML = '<option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>'; } 
                else { dates.forEach(date => { const option = document.createElement('option'); option.value = date; option.textContent = new Date(date + 'T00:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); selector.appendChild(option); }); }
                if (dates.includes(currentVal)) selector.value = currentVal;
            });
            const mainSelector = document.getElementById('schedule-date-selector');
            mainSelector.onchange = (e) => { loadDataForDate(e.target.value); };
            [document.getElementById('scores-date-selector'), document.getElementById('leaderboard-date-selector')].forEach(s => s.onchange = (e) => { loadDataForDate(e.target.value); });
        }
        function renderAllPagesForDate(date) { setupPageSetup(); renderSchedulePage(date); renderScoresPage(date); renderLeaderboardPage(date); }
        function renderSchedulePage(date){const dayData=appData[date];const container=document.getElementById("schedule-container");if(!dayData||!dayData.schedule||0===dayData.schedule.length)return void renderWithMorph(container,createNoDataMessage("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ","üìÖ"));const{schedule:schedule,settings:settings}=dayData,startTime=new Date(`${date}T${settings.startTime}`);let html=schedule.map((match,index)=>{const matchTime=new Date(startTime.getTime()+index*settings.timePerMatch*6e4),timeStr=matchTime.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"}),homeTeam=TEAMS.find(t=>t.slug===match.home)||{name:"N/A",slug:"black"},awayTeam=TEAMS.find(t=>t.slug===match.away)||{name:"N/A",slug:"black"},adminDeleteBtn=currentUser?`<div class="match-actions"><button class="delete-match-btn" data-index="${index}" title="‡∏•‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡∏µ‡πâ">${SVG_TRASH}</button></div>`:"",draggableClass=currentUser?"draggable":"",draggableAttr=currentUser?'draggable="true"':"",clickableTeamClass=currentUser?"clickable-team":"";return`<div class="card match-card ${draggableClass}" data-index="${index}" ${draggableAttr}>
                    <div class="match-header"><span>‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${index+1}</span><span>‚è±Ô∏è ${timeStr}</span>${adminDeleteBtn}</div>
                    <div class="match-body">
                        <div class="team-emblem ${homeTeam.slug} ${clickableTeamClass}" data-index="${index}" data-side="home">${homeTeam.name}</div>
                        <span class="vs">VS</span>
                        <div class="team-emblem ${awayTeam.slug} ${clickableTeamClass}" data-index="${index}" data-side="away">${awayTeam.name}</div>
                    </div>
                </div>`}).join("");currentUser&&dayData.schedule&&(html+='<button id="add-match-btn" class="btn btn-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÉ‡∏´‡∏°‡πà</button>'),renderWithMorph(container,html)}
        function renderScoresPage(date){const dayData=appData[date];const container=document.getElementById("scores-container");if(!dayData||!dayData.schedule||0===dayData.schedule.length)return void renderWithMorph(container,createNoDataMessage("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ","‚úèÔ∏è"));const svgMinus='<svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>',svgPlus='<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>',svgReset='<svg viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9,14.21,4,12,4c-4.42,0-7.99,3.58-7.99,8s3.57,8,7.99,8c3.73,0,6.84-2.55,7.73-6h-2.08c-0.82,2.33-3.04,4-5.65,4-3.31,0-6-2.69-6-6s2.69-6,6-6c1.66,0,3.14,0.69,4.22,1.78L13,11h7V4L17.65,6.35z"/></svg>',{schedule:schedule,settings:settings}=dayData,startTime=new Date(`${date}T${settings.startTime}`),isReadOnly=!currentUser,disabledAttr=isReadOnly?"disabled":"",html=schedule.map((match,index)=>{const matchTime=new Date(startTime.getTime()+index*settings.timePerMatch*6e4),timeStr=matchTime.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"}),homeTeam=TEAMS.find(t=>t.slug===match.home)||{name:"N/A",slug:"black"},awayTeam=TEAMS.find(t=>t.slug===match.away)||{name:"N/A",slug:"black"},readonlyAttr=isReadOnly?"readonly":"",homeScoreText=null!==match.homeScore?match.homeScore:"¬†",awayScoreText=null!==match.awayScore?match.awayScore:"¬†",separator=null!==match.homeScore&&null!==match.awayScore?"-":"vs";return`<div class="card match-card">
                    <div class="match-header"><span>‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${index+1}</span><span>‚è±Ô∏è ${timeStr}</span></div>
                    <div class="score-line-export">
                        <div class="team-emblem ${homeTeam.slug}">${homeTeam.name}</div>
                        <div class="score-block"><span class="score-value">${homeScoreText}</span><span class="vs-export">${separator}</span><span class="score-value">${awayScoreText}</span></div>
                        <div class="team-emblem ${awayTeam.slug}">${awayTeam.name}</div>
                    </div>
                    <div class="interactive-controls">
                        <div class="team-score-wrapper">
                            <div class="team-emblem ${homeTeam.slug}">${homeTeam.name}</div>
                            <div class="score-control">
                                <button class="score-btn" data-index="${index}" data-team="home" data-op="-1" ${disabledAttr}>${svgMinus}</button>
                                <input type="number" class="score-input" value="${null===match.homeScore?"":match.homeScore}" data-index="${index}" data-team="home" ${readonlyAttr}>
                                <button class="score-btn" data-index="${index}" data-team="home" data-op="1" ${disabledAttr}>${svgPlus}</button>
                            </div>
                        </div>
                        <div class="match-center-controls">
                            <span class="vs">VS</span>
                            <button class="reset-score-btn" data-index="${index}" ${disabledAttr}>${svgReset}</button>
                        </div>
                        <div class="team-score-wrapper">
                            <div class="team-emblem ${awayTeam.slug}">${awayTeam.name}</div>
                            <div class="score-control">
                                <button class="score-btn" data-index="${index}" data-team="away" data-op="-1" ${disabledAttr}>${svgMinus}</button>
                                <input type="number" class="score-input" value="${null===match.awayScore?"":match.awayScore}" data-index="${index}" data-team="away" ${readonlyAttr}>
                                <button class="score-btn" data-index="${index}" data-team="away" data-op="1" ${disabledAttr}>${svgPlus}</button>
                            </div>
                        </div>
                    </div>
                </div>`}).join("");renderWithMorph(container,html)}
        function renderLeaderboardPage(date){const dayData=appData[date];const container=document.getElementById("leaderboard-container");if(!dayData||!dayData.settings||!dayData.settings.activeTeams)return void renderWithMorph(container,createNoDataMessage("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô","üìä"));const stats=calculateLeaderboard(date),sortedTeams=Object.values(stats).sort((a,b)=>b.pts!==a.pts?b.pts-a.pts:b.gd!==a.gd?b.gd-a.gd:b.gf!==a.gf?b.gf-a.gf:a.name.localeCompare(b.name)),medals=["ü•á","ü•à","ü•â"],html=`<table class="leaderboard-table">
                <thead><tr><th>#</th><th class="team-name">‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>+/-</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>
                <tbody>${sortedTeams.map((team,index)=>`
                    <tr>
                        <td>${medals[index]||index+1}</td>
                        <td class="team-name"><div class="team-emblem ${team.slug}" style="display:inline-flex; padding: 4px 8px; font-size: 14px;">${team.name}</div></td>
                        <td>${team.p}</td><td>${team.w}</td><td>${team.d}</td><td>${team.l}</td><td>${team.gf}</td><td>${team.ga}</td><td>${team.gd}</td><td><strong>${team.pts}</strong></td>
                    </tr>`).join("")}
                </tbody></table>`;renderWithMorph(container,html)}
        function calculateLeaderboard(date){const dayData=appData[date];if(!dayData||!dayData.schedule||!dayData.settings.activeTeams)return{};const stats={};return dayData.settings.activeTeams.forEach(slug=>{const teamInfo=TEAMS.find(t=>t.slug===slug);teamInfo&&(stats[slug]={name:teamInfo.name,slug:teamInfo.slug,p:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,pts:0})}),dayData.schedule.forEach(match=>{const{home:home,away:away,homeScore:homeScore,awayScore:awayScore}=match;if(null===homeScore||null===awayScore||!stats[home]||!stats[away])return;stats[home].p++,stats[away].p++,stats[home].gf+=homeScore,stats[home].ga+=awayScore,stats[away].gf+=awayScore,stats[away].ga+=homeScore,homeScore>awayScore?(stats[home].w++,stats[away].l++,stats[home].pts+=3):awayScore>homeScore?(stats[away].w++,stats[home].l++,stats[away].pts+=3):(stats[home].d++,stats[away].d++,stats[home].pts+=1,stats[away].pts+=1)}),Object.values(stats).forEach(team=>{team.gd=team.gf-team.ga}),stats}
        function setupNavigation(){navButtons.forEach(button=>{button.addEventListener("click",()=>setActivePage(button.dataset.page))})}
        function setActivePage(pageId){if(!currentUser&&"page-setup"===pageId)return void alert("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");activePage=pageId,shouldRestoreScroll=!1,pages.forEach(page=>page.classList.remove("active")),document.getElementById(pageId).classList.add("active"),navButtons.forEach(btn=>btn.classList.toggle("active",btn.dataset.page===pageId)),content.scrollTop=0}
        function handleMainClick(event){const target=event.target,deleteBtn=target.closest(".delete-match-btn");if(deleteBtn)return void handleDeleteMatch(deleteBtn.dataset.index);const teamEl=target.closest(".clickable-team");if(teamEl)return void openTeamSelectModal(teamEl.dataset.index,teamEl.dataset.side);const addBtn=target.closest("#add-match-btn");if(addBtn)return void handleAddMatch();const scoreBtn=target.closest(".score-btn");if(scoreBtn)return void updateScoreFromButton(scoreBtn);const scoreInput=target.closest(".score-input");if(scoreInput)return void(scoreInput.onchange=()=>updateScoreFromInput(scoreInput));const resetBtn=target.closest(".reset-score-btn");if(resetBtn)return void resetScore(resetBtn);const numStepperBtn=target.closest(".num-stepper-btn");numStepperBtn&&handleNumberStepper(event)}
        function setupPageSetup(){const contentWrapper=document.getElementById("setup-content-wrapper"),loginPrompt=document.getElementById("setup-login-prompt");if(!currentUser)return contentWrapper.style.display="none",loginPrompt.style.display="block",void(loginPrompt.innerHTML=createNoDataMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô","üîê"));if(contentWrapper.style.display="block",loginPrompt.style.display="none",!isInitialSetupDone){const container=document.getElementById("team-toggle-container");container.innerHTML="",TEAMS.forEach(team=>{const toggleHtml=`<div class="team-toggle"><div class="team-emblem ${team.slug}">${team.name}</div><label class="switch"><input type="checkbox" class="team-switch" data-team-slug="${team.slug}" checked><span class="slider"></span></label></div>`;container.innerHTML+=toggleHtml}),document.getElementById("match-date").addEventListener("change",e=>{loadDataForDate(e.target.value)}),document.querySelectorAll(".team-switch").forEach(sw=>sw.addEventListener("change",updateAdvancedOptions)),isInitialSetupDone=!0}updateAdvancedOptions()}
        function loadSettingsFromData(settings){currentUser&&settings&&(document.getElementById("time-per-match").value=settings.timePerMatch||9,document.getElementById("start-time").value=settings.startTime||"20:00",document.querySelectorAll(".team-switch").forEach(sw=>{sw.checked=settings.activeTeams?settings.activeTeams.includes(sw.dataset.teamSlug):!0}),updateAdvancedOptions(),document.getElementById("opener-home").value=settings.opener?.home||"",document.getElementById("opener-away").value=settings.opener?.away||"")}
        function resetSettingsForm(){currentUser&&(document.getElementById("time-per-match").value=9,document.getElementById("start-time").value="20:00",document.querySelectorAll(".team-switch").forEach(sw=>sw.checked=!0),updateAdvancedOptions(),document.getElementById("opener-home").value="",document.getElementById("opener-away").value="")}
        function updateAdvancedOptions(){updateOpenerSelects(),updateTemplateSelector()}
        function updateOpenerSelects(){const openerHomeSelect=document.getElementById("opener-home"),openerAwaySelect=document.getElementById("opener-away"),activeTeamSlugs=Array.from(document.querySelectorAll(".team-switch:checked")).map(sw=>sw.dataset.teamSlug),currentHome=openerHomeSelect.value,currentAway=openerAwaySelect.value;openerHomeSelect.innerHTML='<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>',openerAwaySelect.innerHTML='<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>',activeTeamSlugs.forEach(slug=>{const team=TEAMS.find(t=>t.slug===slug);if(team){const optionHtml=`<option value="${team.slug}">${team.name}</option>`;openerHomeSelect.innerHTML+=optionHtml,openerAwaySelect.innerHTML+=optionHtml}}),openerHomeSelect.value=activeTeamSlugs.includes(currentHome)?currentHome:"",openerAwaySelect.value=activeTeamSlugs.includes(currentAway)?currentAway:""}
        function updateTemplateSelector(){const templateContainer=document.getElementById("template-selector-container"),openerContainer=document.getElementById("opener-selector-container"),selector=document.getElementById("template-selector"),teamCount=document.querySelectorAll(".team-switch:checked").length,templateKey=`${teamCount}-teams`,templates=MASTER_TEMPLATES[templateKey];templates&&templates.length>1?(selector.innerHTML="",templates.forEach((template,index)=>{const option=document.createElement("option");option.value=index,option.textContent=template.name,selector.appendChild(option)}),templateContainer.style.display="block"):templateContainer.style.display="none",4===teamCount||5===teamCount?openerContainer.style.display="none":openerContainer.style.display="block"}
        function generateScheduleFromTemplate(teams,templateIndex=0,opener=null){const teamCount=teams.length,templateKey=`${teamCount}-teams`;if(!MASTER_TEMPLATES[templateKey]||!MASTER_TEMPLATES[templateKey][templateIndex])throw new Error(`Template not found for ${teamCount} teams at index ${templateIndex}.`);let numberTemplate=[...MASTER_TEMPLATES[templateKey][templateIndex].data];const teamToNumberMap=new Map,numberToTeamMap=new Map;teams.forEach((teamSlug,index)=>{const number=index+1;teamToNumberMap.set(teamSlug,number),numberToTeamMap.set(number,teamSlug)});let translatedSchedule=numberTemplate.map(match=>({home:numberToTeamMap.get(match.home),away:numberToTeamMap.get(match.away)})).filter(match=>match.home&&match.away);if(opener&&opener.home&&opener.away){const openerIndex=translatedSchedule.findIndex(m=>m.home===opener.home&&m.away===opener.away);openerIndex>0&&(translatedSchedule=[...translatedSchedule.slice(openerIndex),...translatedSchedule.slice(0,openerIndex)])}return translatedSchedule}
        function generateDoubleRoundRobin(teams){let teamList=[...teams];const BYE="BYE_TEAM_PLACEHOLDER";teamList.length%2!=0&&teamList.push(BYE);const numTeams=teamList.length,numRounds=numTeams-1,leg1=[];for(let round=0;round<numRounds;round++){for(let i=0;i<numTeams/2;i++){const home=teamList[i],away=teamList[numTeams-1-i];home!==BYE&&away!==BYE&&leg1.push({home:home,away:away})}teamList.splice(1,0,teamList.pop())}const leg2=leg1.map(match=>({home:match.away,away:match.home}));return[...leg1,...leg2]}
        function handleAddMatch(){if(!currentUser)return;const dayData=appData[currentDateKey];if(!dayData||!dayData.settings.activeTeams||dayData.settings.activeTeams.length<2)return void alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ó‡∏µ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ó‡∏µ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏°‡∏ï‡∏ä‡πå");let newSchedule=dayData.schedule?[...dayData.schedule]:[];newSchedule.push({home:dayData.settings.activeTeams[0],away:dayData.settings.activeTeams[1],homeScore:null,awayScore:null}),updateScheduleOrderInSheet(newSchedule)}
        function handleDeleteMatch(index){const idx=parseInt(index,10);if(!currentUser)return;const dayData=appData[currentDateKey];if(!dayData)return;if(confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${idx+1}" ?`)){let newSchedule=[...dayData.schedule];newSchedule.splice(idx,1),updateScheduleOrderInSheet(newSchedule)}}
        function openTeamSelectModal(index,side){if(!currentUser)return;currentEditingContext={index:parseInt(index),side:side};const dayData=appData[currentDateKey],activeTeams=dayData.settings.activeTeams,modalList=document.getElementById("team-select-modal-list");document.getElementById("team-select-modal-title").textContent=`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°${"home"===side?"‡πÄ‡∏´‡∏¢‡πâ‡∏≤":"‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô"}‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${currentEditingContext.index+1}`,modalList.innerHTML="",activeTeams.forEach(slug=>{const team=TEAMS.find(t=>t.slug===slug);if(team){const teamEl=document.createElement("div");teamEl.className=`team-emblem ${team.slug} clickable`,teamEl.textContent=team.name,teamEl.dataset.slug=team.slug,teamEl.onclick=()=>handleTeamSelection(team.slug),modalList.appendChild(teamEl)}}),teamSelectModal.style.display="block"}
        async function handleTeamSelection(newTeamSlug){const{index:index,side:side}=currentEditingContext;if(null===index||!side)return;const dayData=appData[currentDateKey];let newSchedule=[...dayData.schedule];const match=newSchedule[index],otherSide="home"===side?"away":"home";if(match[otherSide]===newTeamSlug)return void alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ");match[side]=newTeamSlug,teamSelectModal.style.display="none",await updateScheduleOrderInSheet(newSchedule)}
        function updateScoreFromButton(button){const{index:index,team:team,op:op}=button.dataset,input=document.querySelector(`.score-input[data-index="${index}"][data-team="${team}"]`);let currentValue=parseInt(input.value||"0"),newValue="1"===op?currentValue+1:Math.max(0,currentValue-1);input.value=newValue,updateScoreInSheet(parseInt(index),team,newValue)}
        function updateScoreFromInput(input){const{index:index,team:team}=input.dataset;let value=""===input.value?null:Math.max(0,parseInt(input.value));updateScoreInSheet(parseInt(index),team,value)}
        function resetScore(button){const{index:index}=button.dataset,intIndex=parseInt(index);updateScoreInSheet(intIndex,"home",null),updateScoreInSheet(intIndex,"away",null),document.querySelector(`.score-input[data-index="${index}"][data-team="home"]`).value="",document.querySelector(`.score-input[data-index="${index}"][data-team="away"]`).value=""}
        function setupDragAndDropListeners(container){container.addEventListener("dragstart",handleDragStart),container.addEventListener("dragend",handleDragEnd),container.addEventListener("dragover",handleDragOver),container.addEventListener("drop",handleDrop)}
        function handleDragStart(event){const draggable=event.target.closest(".match-card.draggable");draggable&&(draggedItem=draggable,event.dataTransfer.effectAllowed="move",event.dataTransfer.setData("text/plain",draggable.dataset.index),setTimeout(()=>{draggedItem.classList.add("dragging")},0))}
        function handleDragEnd(event){if(!draggedItem)return;draggedItem.classList.remove("dragging"),draggedItem=null;const placeholder=document.querySelector(".drag-over-placeholder");placeholder&&placeholder.remove()}
        function handleDragOver(event){event.preventDefault();const container=event.currentTarget,afterElement=getDragAfterElement(container,event.clientY);let placeholder=container.querySelector(".drag-over-placeholder");placeholder||(placeholder=document.createElement("div"),placeholder.classList.add("drag-over-placeholder")),container.insertBefore(placeholder,afterElement)}
        function handleDrop(event){event.preventDefault();const container=event.currentTarget,placeholder=container.querySelector(".drag-over-placeholder");if(!placeholder||!draggedItem)return;placeholder.parentNode.insertBefore(draggedItem,placeholder),placeholder.remove();const newOrderedSchedule=Array.from(container.querySelectorAll(".match-card[data-index]")).map(card=>parseInt(card.dataset.index,10)).map(originalIndex=>appData[currentDateKey].schedule[originalIndex]);debouncedUpdateInSheet(newOrderedSchedule)}
        function getDragAfterElement(container,y){const draggableElements=[...container.querySelectorAll(".match-card.draggable:not(.dragging)")];return draggableElements.reduce((closest,child)=>{const box=child.getBoundingClientRect(),offset=y-box.top-box.height/2;return offset<0&&offset>closest.offset?{offset:offset,element:child}:closest},{offset:Number.NEGATIVE_INFINITY}).element}
        function handleNumberStepper(event){const op=parseInt(event.currentTarget.dataset.op),targetId=event.currentTarget.dataset.target,input=document.getElementById(targetId);if(input){const step=parseFloat(input.step)||1,min=parseFloat(input.min);let currentValue=parseFloat(input.value)||0,newValue=currentValue+op*step;!isNaN(min)&&newValue<min&&(newValue=min),input.value=parseFloat(newValue.toPrecision(12))}}
        function exportElementAsPNG(elementId,filename,buttonElement){const element=document.getElementById(elementId);if(!element||element.innerHTML.includes("no-data-message"))return void alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export");const originalText=buttonElement.innerHTML;buttonElement.innerHTML="‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...",buttonElement.disabled=!0;const exportWrapper=document.createElement("div");exportWrapper.className="temp-export-container";const headerDiv=document.createElement("div");headerDiv.className="export-header";let title="";"schedule-container"===elementId?title="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô":"scores-container"===elementId?title="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô":"leaderboard-container"===elementId&&(title="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");const formattedDate=(new Date(currentDateKey+"T00:00:00")).toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"});headerDiv.innerHTML=`<h1>${title}</h1><h2>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formattedDate}</h2>`,exportWrapper.appendChild(headerDiv);const contentClone=element.cloneNode(!0),isGridExport="schedule-container"===elementId||"scores-container"===elementId;if(isGridExport){contentClone.classList.add("export-mode-grid");const matchCards=contentClone.querySelectorAll(".match-card"),totalMatches=matchCards.length;if(totalMatches>0){const rows=Math.ceil(totalMatches/2);contentClone.style.gridTemplateRows=`repeat(${rows}, auto)`}}"leaderboard-container"===elementId?exportWrapper.style.width="1200px":exportWrapper.style.width="840px",exportWrapper.appendChild(contentClone),document.body.appendChild(exportWrapper),html2canvas(exportWrapper,{backgroundColor:"#121212",useCORS:!0,scale:2}).then(canvas=>{const link=document.createElement("a");link.download=filename,link.href=canvas.toDataURL("image/png"),link.click(),showToast("‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")}).catch(err=>{console.error("Oops, something went wrong!",err),alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û")}).finally(()=>{document.body.removeChild(exportWrapper),buttonElement.innerHTML=originalText,buttonElement.disabled=!1})}
    </script>
</body>
</html>
